<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #49483e }
body { background: #272822; color: #f8f8f2 }
body .c { color: #75715e } /* Comment */
body .err { color: #960050; background-color: #1e0010 } /* Error */
body .esc { color: #f8f8f2 } /* Escape */
body .g { color: #f8f8f2 } /* Generic */
body .k { color: #66d9ef } /* Keyword */
body .l { color: #ae81ff } /* Literal */
body .n { color: #f8f8f2 } /* Name */
body .o { color: #f92672 } /* Operator */
body .x { color: #f8f8f2 } /* Other */
body .p { color: #f8f8f2 } /* Punctuation */
body .ch { color: #75715e } /* Comment.Hashbang */
body .cm { color: #75715e } /* Comment.Multiline */
body .cp { color: #75715e } /* Comment.Preproc */
body .cpf { color: #75715e } /* Comment.PreprocFile */
body .c1 { color: #75715e } /* Comment.Single */
body .cs { color: #75715e } /* Comment.Special */
body .gd { color: #f92672 } /* Generic.Deleted */
body .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
body .gr { color: #f8f8f2 } /* Generic.Error */
body .gh { color: #f8f8f2 } /* Generic.Heading */
body .gi { color: #a6e22e } /* Generic.Inserted */
body .go { color: #66d9ef } /* Generic.Output */
body .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
body .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
body .gu { color: #75715e } /* Generic.Subheading */
body .gt { color: #f8f8f2 } /* Generic.Traceback */
body .kc { color: #66d9ef } /* Keyword.Constant */
body .kd { color: #66d9ef } /* Keyword.Declaration */
body .kn { color: #f92672 } /* Keyword.Namespace */
body .kp { color: #66d9ef } /* Keyword.Pseudo */
body .kr { color: #66d9ef } /* Keyword.Reserved */
body .kt { color: #66d9ef } /* Keyword.Type */
body .ld { color: #e6db74 } /* Literal.Date */
body .m { color: #ae81ff } /* Literal.Number */
body .s { color: #e6db74 } /* Literal.String */
body .na { color: #a6e22e } /* Name.Attribute */
body .nb { color: #f8f8f2 } /* Name.Builtin */
body .nc { color: #a6e22e } /* Name.Class */
body .no { color: #66d9ef } /* Name.Constant */
body .nd { color: #a6e22e } /* Name.Decorator */
body .ni { color: #f8f8f2 } /* Name.Entity */
body .ne { color: #a6e22e } /* Name.Exception */
body .nf { color: #a6e22e } /* Name.Function */
body .nl { color: #f8f8f2 } /* Name.Label */
body .nn { color: #f8f8f2 } /* Name.Namespace */
body .nx { color: #a6e22e } /* Name.Other */
body .py { color: #f8f8f2 } /* Name.Property */
body .nt { color: #f92672 } /* Name.Tag */
body .nv { color: #f8f8f2 } /* Name.Variable */
body .ow { color: #f92672 } /* Operator.Word */
body .pm { color: #f8f8f2 } /* Punctuation.Marker */
body .w { color: #f8f8f2 } /* Text.Whitespace */
body .mb { color: #ae81ff } /* Literal.Number.Bin */
body .mf { color: #ae81ff } /* Literal.Number.Float */
body .mh { color: #ae81ff } /* Literal.Number.Hex */
body .mi { color: #ae81ff } /* Literal.Number.Integer */
body .mo { color: #ae81ff } /* Literal.Number.Oct */
body .sa { color: #e6db74 } /* Literal.String.Affix */
body .sb { color: #e6db74 } /* Literal.String.Backtick */
body .sc { color: #e6db74 } /* Literal.String.Char */
body .dl { color: #e6db74 } /* Literal.String.Delimiter */
body .sd { color: #e6db74 } /* Literal.String.Doc */
body .s2 { color: #e6db74 } /* Literal.String.Double */
body .se { color: #ae81ff } /* Literal.String.Escape */
body .sh { color: #e6db74 } /* Literal.String.Heredoc */
body .si { color: #e6db74 } /* Literal.String.Interpol */
body .sx { color: #e6db74 } /* Literal.String.Other */
body .sr { color: #e6db74 } /* Literal.String.Regex */
body .s1 { color: #e6db74 } /* Literal.String.Single */
body .ss { color: #e6db74 } /* Literal.String.Symbol */
body .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
body .fm { color: #a6e22e } /* Name.Function.Magic */
body .vc { color: #f8f8f2 } /* Name.Variable.Class */
body .vg { color: #f8f8f2 } /* Name.Variable.Global */
body .vi { color: #f8f8f2 } /* Name.Variable.Instance */
body .vm { color: #f8f8f2 } /* Name.Variable.Magic */
body .il { color: #ae81ff } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_md_file_to_react</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">is_folder_readme</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_course_readme</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">article_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">is_readme</span> <span class="o">=</span> <span class="n">is_folder_readme</span> <span class="ow">or</span> <span class="n">is_course_readme</span>

    <span class="c1"># set article type (article, folder readme, course readme)</span>
    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span>
    <span class="k">if</span> <span class="n">is_folder_readme</span><span class="p">:</span> <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;folder&#39;</span>
    <span class="k">if</span> <span class="n">is_course_readme</span><span class="p">:</span> <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;course&#39;</span>

    <span class="c1"># extract article date from first line</span>
    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;coming_soon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_readme</span><span class="p">:</span> <span class="c1"># don&#39;t extract date from readmes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">second</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;created &#39;</span><span class="p">):</span>
                <span class="n">mod_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_date</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_to_str</span><span class="p">(</span><span class="n">mod_date</span><span class="p">)</span>
                <span class="n">cr_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">second</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_date</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_to_str</span><span class="p">(</span><span class="n">cr_date</span><span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">rest</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># no creation date supplied</span>
                <span class="n">mod_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_date</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_to_str</span><span class="p">(</span><span class="n">mod_date</span><span class="p">)</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_date</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_to_str</span><span class="p">(</span><span class="n">mod_date</span><span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">second</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">rest</span>
                
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no date found on first line of </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">, marking as &quot;coming soon&quot;&#39;</span><span class="p">)</span>
            <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PLACEHOLDER_TIMESTAMP</span>
            <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PLACEHOLDER_TIMESTAMP</span>
            <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;coming_soon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PLACEHOLDER_TIMESTAMP</span>
        <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;mod_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PLACEHOLDER_TIMESTAMP</span>
        <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;cr_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># extract article tags, if they exist</span>
    <span class="n">first</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">first</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[TAGS]&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">first</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s1">&#39;[TAGS]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">split_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">split_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;colour&#39;</span><span class="p">:</span> <span class="n">split_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;something wrong with the tags specified in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">, skipping tag extraction&#39;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">rest</span>

    <span class="c1"># identify article title</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;```.*?\n# .*?\n```|\n# (.*?)\n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">file</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span> <span class="c1"># identify lines starting with &#39;# &#39; that aren&#39;t inside a code block (might be first line, so prepend \n)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">titles</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="c1"># for invalid titles, the capture group is empty but still exists, so need to remove them</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no_title&#39;</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no article title found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;multiple article titles found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">, using first one&#39;</span><span class="p">)</span>

    <span class="c1"># replace \\ with \\\\, because for some reason later \\ is replaced with \ (probably by markdown2)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\\\\\\\</span><span class="s1">&#39;</span><span class="p">)</span> 
    <span class="c1"># ensure displayed latex is preceded+followed by two newlines (only for lines that start with $$, so we can still have e.g. &quot;&gt; $$asdf$$&quot;), so that markdown2 will wrap it in &lt;p&gt;, so that it gets registered as not the first child in theorems/props etc.</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\n\$\$.*?\$\$)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\n\n\1\n\n&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="c1"># ensure that &lt;Spoiler&gt; and &lt;/Spoiler&gt; are preceded+followed by two newlines, so that markdown2 will wrap them in p tags (i.e. there won&#39;t be junk between spoiler tag and p tag)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;(/?)Spoiler(/?)&gt;\n?([^\n])&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;\1Spoiler\2&gt;\n\n\3&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^\n])\n?&lt;(/?)Spoiler(/?)&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1\n\n&lt;\2Spoiler\3&gt;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="c1"># do the same for &lt;hr&gt; and &lt;/hr&gt;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;(/?)hr(/?)&gt;\n?([^\n])&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;\1hr\2&gt;\n\n\3&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^\n])\n?&lt;(/?)hr(/?)&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1\n\n&lt;\2hr\3&gt;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="c1"># do the same for math tags</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">math_tags</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;(/?)&#39;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;([^&gt;]*?)&gt;\n?([^\n])&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;\1&#39;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\2&gt;\n\n\3&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^\n])\n?&lt;(/?)&#39;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;([^&gt;]*?)&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1\n\n&lt;\2&#39;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\3&gt;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="c1"># find literal braces, for latex (so that the backslash doesn&#39;t die when being parsed)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">{&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp;#123;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">}&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp;#125;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="c1"># in copiable code blocks, add copy buttons</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;__COPIABLE__\n```(.*?)\n(.*?)\n```&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># reverse so can edit the string without indices changing</span>
        <span class="n">lang</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">copiable</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">)</span> <span class="c1"># copy button component takes newlines as literals</span>
        <span class="n">copiable</span> <span class="o">=</span> <span class="n">copiable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="s1">&#39;__COPIABLE__</span><span class="se">\n\n</span><span class="s1">&lt;CopyButton text=&quot;&#39;</span> <span class="o">+</span> <span class="n">copiable</span> <span class="o">+</span> <span class="s1">&#39;&quot;/&gt;</span><span class="se">\n\n</span><span class="s1">```&#39;</span> <span class="o">+</span> <span class="n">lang</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">```&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">[:</span><span class="n">m</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">modified</span> <span class="o">+</span> <span class="n">file</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:]</span>
    <span class="c1"># set proofs inside theorem blocks to be unquoted and unbolded</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Thm&#39;</span><span class="p">,</span> <span class="s1">&#39;Lemma&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;[^&gt;]*?&gt;)(.*?)(&lt;/&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&gt;)&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># reverse so can edit the string without indices changing</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;Proof[^&gt;]*?)(&gt;.*?)(&lt;/Proof&gt;)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1 unquoted unbolded\2\3&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">[:</span><span class="n">m</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">modified</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">file</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:]</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fenced-code-blocks&#39;</span><span class="p">,</span> <span class="s1">&#39;codehilite&#39;</span><span class="p">,</span> <span class="s1">&#39;code-friendly&#39;</span><span class="p">,</span> <span class="s1">&#39;header-ids&#39;</span><span class="p">,</span> <span class="s1">&#39;footnotes&#39;</span><span class="p">,</span> <span class="s1">&#39;wiki-tables&#39;</span><span class="p">])</span>

    <span class="c1"># replace curly braces with html character codes, so that react ignores them</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#123;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#125;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

    <span class="c1"># pre doesn&#39;t work in nextjs, so find all whitespace inside pre tags and replace with character codes</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">span</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;pre&gt;)(.*?)(?=&lt;/pre&gt;)&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># reverse so can edit the string without indices changing</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">page</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;span &#39;</span><span class="p">,</span> <span class="s1">&#39;span#&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="c1"># temp</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="c1"># replace whitespace</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;span#&#39;</span><span class="p">,</span> <span class="s1">&#39;span &#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="c1"># replace newlines</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">[:</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="n">page</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>

    <span class="c1"># add &lt;Latex&gt; tags</span>
    <span class="c1"># for blocks inside blockquotes, the background is not white (so add scrollshadow-horizontal-blockquote instead of scrollshadow-horizontal)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;p&gt;\$\$(.*?)\$\$&lt;/p&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;Latex&gt;\1&lt;/Latex&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="c1"># remove &lt;p&gt; tags that markdown added</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$\$(.*?)\$\$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;Latex&gt;\1&lt;/Latex&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="c1"># temporarily remove double dollar signs, so that can deal with single dollar signs first</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$(.+?)\$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;Latex&gt;$\1$&lt;/Latex&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
    <span class="c1"># need block span instead of div so that doesn&#39;t trigger hydration error</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;Thm&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Lemma&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Proof&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Defn&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">,</span><span class="s1">&#39;quoted&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;blockquote&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Spoiler&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]:</span>
        <span class="n">tag</span><span class="p">,</span><span class="n">quoted</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">span</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;[^&gt;]*?&#39;</span><span class="o">+</span><span class="n">quoted</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;.*?&gt;.*?&lt;/&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># reverse so can edit the string without indices changing</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">page</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># unquoted blocks aren&#39;t grey, so skip</span>
            <span class="k">if</span> <span class="s1">&#39;unquoted&#39;</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span><span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="c1"># replace $$</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;Latex&gt;([^$].*?[^$])&lt;/Latex&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;span className=&quot;scrollshadow-horizontal-blockquote latex-display-wrapper&quot;&gt;&lt;Latex&gt;$$\1$$&lt;/Latex&gt;&lt;/span&gt;&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">[:</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="n">page</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;Latex&gt;([^$].*?[^$])&lt;/Latex&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;span className=&quot;scrollshadow-horizontal latex-display-wrapper&quot;&gt;&lt;Latex&gt;$$\1$$&lt;/Latex&gt;&lt;/span&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

    <span class="c1"># &lt;p&gt; tags will have been placed around the following tags (on purpose), remove them</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CopyButton&#39;</span><span class="p">,</span> <span class="s1">&#39;Spoiler&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">math_tags</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;p&gt;(&lt;/?&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;.*?&gt;)&lt;/p&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

    <span class="c1"># find h2 tags, add link anchor to them, and generate table of contents from h2 tags (each h2 tag is given a unique id by the header-ids extension)</span>
    <span class="n">table_of_contents</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;h2 id=&quot;(.*?)&quot;&gt;(.*?)&lt;/h2&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)]</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">add_link_anchors</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>

    <span class="c1"># markdown added class attributes, replace with &quot;className&quot; for react</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;class=&#39;</span><span class="p">,</span><span class="s1">&#39;className=&#39;</span><span class="p">)</span>

    <span class="c1"># move copy buttons generated above (i.e. in code blocks marked __COPIABLE__) into their containers</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;p&gt;__COPIABLE__&lt;/p&gt;\n\n&lt;CopyButton(.*?)/&gt;\n\n&lt;div className=&quot;codehilite&quot;&gt;\n&lt;pre&gt;(.*?)&lt;/pre&gt;\n&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;div className=&quot;codehilite relative&quot;&gt;\n&lt;div className=&quot;absolute top-2 right-2&quot;&gt;&lt;CopyButton\1/&gt;&lt;/div&gt;\n&lt;pre&gt;\2&lt;/pre&gt;\n&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;p&gt;__COPIABLE__&lt;/p&gt;\n\n&lt;CopyButton(.*?)/&gt;\n\n&lt;pre&gt;(.*?)&lt;/pre&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&lt;pre className=&quot;relative&quot;&gt;\n&lt;div className=&quot;absolute top-2 right-2&quot;&gt;&lt;CopyButton\1/&gt;&lt;/div&gt;\n\2&lt;/pre&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten_content</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">))</span>

    <span class="n">path_list</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">beautify</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># path to parent folder</span>
    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_readme</span> <span class="k">else</span> <span class="n">path_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># readmes should be elevated</span>

    <span class="n">article_name</span> <span class="o">=</span> <span class="n">target_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">article_name</span>

    <span class="n">page_title</span> <span class="o">=</span> <span class="n">article_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">copiable_article_plaintext</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">COURSE_INDICATOR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span> <span class="c1"># don&#39;t add &quot;copy article plaintext&quot; button to course content</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">article_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="o">+</span> <span class="n">plaintext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">plaintext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">)</span>
        <span class="c1"># replace braces for nextjs</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">plaintext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#123;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#125;&#39;</span><span class="p">)</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">plaintext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">)</span> <span class="c1"># copy button component takes newlines as literals</span>
        <span class="n">copiable_article_plaintext</span> <span class="o">=</span> <span class="n">plaintext</span>
    
    <span class="k">return</span> <span class="n">page</span><span class="p">,</span> <span class="n">article_data</span><span class="p">,</span> <span class="n">page_title</span><span class="p">,</span> <span class="n">copiable_article_plaintext</span><span class="p">,</span> <span class="n">table_of_contents</span>
</pre></div>
</body>
</html>
